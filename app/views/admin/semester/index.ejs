<%- include("../partials/head") %>
<%- include("../partials/leftSidebar") %>
<%- include("../partials/header") %>
<%- include("../partials/loader") %>

<div class="col-12 dashboardContent">
  <!--DASHBOARD CONTENT START-->
  <div class="card">
    <div class="card-header">
      <h1 class="f-20">Add Semester Data</h1>
      <form action='/semester/getSemesterDataSAP' method='POST'>
        <button class="btn btn-danger m-auto d-block float-right"><i class="fas fa-download"></i>Fetch from SAP</button>
      </form>
    </div>
    <div class="card-body">
      <% if (semesterData == 'school not found' || semesterData == 'WSDL client creation issue' || 
                              semesterData == 'WSDL client connection issue' || semesterData == 'table truncate' || semesterData == 'table insert') { %>
      <h6 class="bg-danger text-white p-3">Error occured while fetching Semester Data</h6>
      <% } else if (semesterData > 0) { %>
      <h6 class="bg-success text-white p-3">Done! Semester Data Fetched Successfully</h6>
      <% } %>
      <form>

        <div class="form-row mt-3">
          <div class="col-sm-6 mt-2">
            <label class="font-weight-bold mb-0">Select Program</label>
            <select class="form-control req" id="programIdForSemesterData" required>
            </select>
          </div>
          <div class="col-sm-6 mt-2">
            <label class="font-weight-bold mb-0">Select Semester</label>
            <select class="form-control req" id="semesterNameforSemesterData" required>
            </select>
          </div>
          <div class="col-sm-6 mt-2">
            <label class="font-weight-bold mb-0">Start Date</label>
            <input id="startDateForSemesterData" type="date" class="form-control req" required>
          </div>
          <div class="col-sm-6 mt-2">
            <label class="font-weight-bold mb-0">End Date</label>
            <input id="endDateForSemesterData" type="date" class="form-control req" required>
          </div>
        </div>
        <div class="form-row mt-3">
          <div class="col text-center">
            <button id="addSemesterData" class="btn btn-sm btn-dark w-100">Submit</button>
          </div>
        </div>
      </form>
      <hr />

      <div class="table-responsive">
        <table id="semesterDataTable" class="table table-striped call-datatable">
          <thead>
            <tr>
              <th scope="col">Program ID</th>
              <th scope="col">Semester</th>
              <th scope="col">Start Date</th>
              <th scope="col">End Date</th>
              <th scope="col">Status</th>
            </tr>
          </thead>
          <tbody>
            <% for(let data of semesterData) { %>
            <tr>
              <td><%- data.programId %></td>
              <td><%- data.semester %></td>
              <td><%- data.startDate %></td>
              <td><%- data.endDate %></td>
              <td>
                <div class="custom-control custom-switch">
                  <input type="checkbox" class="custom-control-input change-status" data-id="<%- data.id %>"
                    id="toggle<%- data.id %>" <%- data.active == 'Y' ? "checked" : "" %>>
                  <label class="custom-control-label cursor-pointer" for="toggle<%- data.id %>"></label>
                </div>
              </td>
            </tr>
            <% } %>
          </tbody>
          <tfoot>
            <tr>
              <td></td>
              <td></td>
              <td></td>
              <td></td>
              <td></td>
            </tr>
          </tfoot>
        </table>
      </div>


    </div>
  </div>
  <!--DASHBOARD CONTENT END-->

  <%- include("../partials/footer") %>
  <script>
    $(document).ready(function () {

      function callDatatable() {
        if ($('.call-datatable').length > 0) {
          //CALL DATATABLE

          $('.call-datatable').DataTable({
            autoFill: false,
            //scrollY: 400,
            scrollX: '100%',
            deferRender: true,
            scrollY: true,
            scrollX: true,
            paging: true,
            initComplete: function () {
              this.api().columns().every(function () {
                var column = this;
                var select = $(
                    '<select><option value="">-Select-</option></select>'
                  )
                  .appendTo($(column.footer()).empty())
                  .on('change', function () {
                    var val = $.fn.dataTable.util.escapeRegex(
                      $(this).val()
                    );

                    column
                      .search(val ? '^' + val + '$' : '',
                        true, false)
                      .draw();
                  });

                column.data().unique().sort().each(function (d, j) {
                  select.append('<option value="' + d +
                    '">' + d + '</option>')
                });
              });
            }
          })
          //CALL DATATABLE END
        }
      }
      callDatatable()


      $(document).on('change', '.change-status', function () {
        let isChecked = $(this).is(':checked');
        let status = isChecked ? 'Y' : 'N';
        let id = $(this).attr('data-id');

        console.log("This value===>>> ", isChecked)
        $('.loaderBody').removeClass('d-none');

        $.ajax({
          url: '/semester/change-status',
          type: 'POST',
          data: {
            status: status,
            id: id
          },
          success: data => {
            console.log('Success===>> ', data)
            $('.loaderBody').addClass('d-none');
            if (data.cause == "permission denied") {
					   	window.location = data.reqUrl
					  	return
					  }
            $('.alertBody').removeClass('d-none')
            $('.alertBody .alert-text').html(`${data.message}`)

          },
          error: err => {
            console.log(err)
          }
        })
      })



    })
  </script>
  <%- include("../partials/footerEnd") %>