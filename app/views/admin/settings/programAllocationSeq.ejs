<%- include("../partials/head") %>
<%- include("../partials/leftSidebar") %>
<%- include("../partials/header") %>

<div class="col-12 dashboardContent">
    <!--DASHBOARD CONTENT START-->
    <div class="card">
        <div class="card-header bg-danger text-white">
            <h1 class="f-20">Program Allocation Sequence</h1>
        </div>
        <div class="card-body">
            <div class="col-12 mb-3">
                <table id="programSequenceTable" class="table table-bordered table-striped call-datatable text-center">
                    <thead>
                        <tr>
                            <th scope='col'>Program Name</th>
                            <th scope='col'>Allocation Preference</th>
                        </tr>
                    </thead>
                    <tbody>

                        <% for(let value of data) { %>
                        <tr>
                            <td name="<%- value.programId %>"><%- value.programName %></td>
                            <td><input type='number' class='text-center form-control'
                                    value='<%- value.allocationSequence %>' min="0" max="<%- data.length %>" /></td>
                        </tr>
                        <% } %>
                    </tbody>
                </table>
            </div>
            <div class="col-12 text-center">
                <button id="saveProgramAllocationSeq" class="btn btn-success">Save Preference</button>
            </div>
        </div>
    </div>

    <!--DASHBOARD CONTENT END-->

   <%- include("../partials/footer") %>
    <script>
        $(document).ready(function () {

            $("#saveProgramAllocationSeq").click(function () {
                let inputArr = [];
                $("#programSequenceTable input[type='number']").each(function () {
                    if ($(this).val() != 0) {
                        inputArr.push($(this).val());
                    }
                })

                console.log(inputArr)

                let sortedInputArr = inputArr.sort();
                let arrLength = inputArr.length;
                let inputIsSame = false;

                if (arrLength > 0) {
                    for (let i = 0; i < arrLength - 1; i++) {
                        console.log(i + 1, " || ", i)
                        if (sortedInputArr[i] == sortedInputArr[i + 1]) {
                            $(".alertBody").removeClass('d-none').find(".alert-text").html("Opps! You cannot assign same value to two or more input field.")
                            return inputIssame = true;
                        }
                    }
                }
                console.log("Is Input Same? ", inputIsSame)

                if (inputIsSame == false) {
                    var programSeq = new Map();
                    $("#programSequenceTable tbody tr").each(function () {
                        let programId = $(this).find("td:first-child").attr('name')
                        let allocationSeq = $(this).find("input").val()
                        programSeq.set(programId, allocationSeq)
                    })

                    console.log("Program Sequence MAP", programSeq)
                    $.ajax({
                        type: "POST",
                        url: "/settings/updateProgramAllocationSeq",
                        dataType: "JSON",
                        data: {
                            programSeqMap: JSON.stringify(Array.from(programSeq.entries()))
                        },
                        success: function (data) {
                            if (data.cause == "permission denied") {
							window.location = data.reqUrl
							return
				            }
                            console.log("Updated Data", data)
                            if (data.status === '200') {
                                $(".alertBody").removeClass('d-none').find(".alert-text")
                                    .html(data.message)
                            } else {
                                $(".alertBody").removeClass('d-none').find(".alert-text").html("Error occured! Your preference could not be updated.")
                            }
                        }
                    })
                }
            })

            $("#programSequenceTable").on("keyup", "input[type='number']", function (event) {
                $this = $(this);
                let minVal = Number($this.attr('min'));
                let maxVal = Number($this.attr('max'));
                let $thisVal = Number($this.val());
                let $thisStr = $thisVal.toString()

                if ($thisStr.length > 1) {
                    $thisStr.replace(/^0+/, '');
                }
                if (event.keyCode == 110 || event.keyCode == 190 || event.keyCode == 187 || event
                    .keyCode == 107 || event.keyCode == 189 || event.keyCode == 109) {
                    $this.val("").val(0)
                } else if ($thisVal > maxVal) {
                    console.log("Is Greater")
                    $this.val(maxVal)
                } else if ($thisVal < minVal) {
                    console.log("Is Smaller")
                    $this.val(minVal)
                } else {

                    $this.val($thisStr)
                }
            })

        })
    </script>
    <%- include("../partials/footerEnd") %>